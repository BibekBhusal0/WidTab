import { useEffect, useState, useRef, JSX } from "react";
import favicon from "@/assets/img/favicon/favicon.png";
import { useSelector } from "react-redux";
import { StateType } from "@/redux/store";
import { useTheme } from "@mui/material/styles";

const size = 64;
const googleFaviconAPI = (url: string) => {
  const hostName = new URL(url).hostname;
  return `https://s2.googleusercontent.com/s2/favicons?domain_url=https://${hostName}&sz=${size}`;
};
const chromeFaviconApi = (_: string) => {
  return favicon;
};

const Favicon = ({ src, ...props }: JSX.IntrinsicElements["img"]) => {
  const googleFavicon = googleFaviconAPI(src || "");
  const chromeFavicon = chromeFaviconApi(src || "");
  const [logoSrc, setLogoSrc] = useState<string>(googleFavicon);
  const imgRef = useRef<HTMLImageElement>(null);
  const isGoogleFavicon = logoSrc === googleFavicon;

  useEffect(() => {
    if (src) setLogoSrc(googleFavicon);
  }, [src]);

  if (!src) return null;

  const handleImageError = () => {
    if (isGoogleFavicon) setLogoSrc(chromeFavicon);
  };

  const handleImageLoad = () => {
    if (!imgRef.current) return;
    const { naturalWidth, naturalHeight } = imgRef.current;
    if (naturalWidth === 16 && naturalHeight === 16 && isGoogleFavicon) {
      setLogoSrc(chromeFavicon);
    }
  };

  return (
    <img
      ref={imgRef}
      src={logoSrc}
      alt="Favicon"
      onError={handleImageError}
      onLoad={handleImageLoad}
      {...props}
    />
  );
};

export { Favicon, chromeFaviconApi, googleFaviconAPI };
export default Favicon;

export function useFavicon() {
  const { currentSpace } = useSelector((state: StateType) => state.layout);
  const {
    palette: {
      primary: { contrastText, main },
    },
  } = useTheme();
  var innerIcon = `<path d="M34.018 45.1682C34.018 41.5209 34.018 39.6973 35.1579 38.5631C36.2978 37.4288 38.133 37.4305 41.8018 37.4305C45.4705 37.4305 47.3058 37.4305 48.4457 38.5631C49.5856 39.6991 49.5856 41.5209 49.5856 45.1682V49.037C49.5856 52.6843 49.5856 54.5079 48.4457 55.6422C47.3058 56.7764 45.4705 56.7747 41.8018 56.7747C38.133 56.7747 36.2978 56.7747 35.1579 55.6422C34.018 54.5061 34.018 52.6843 34.018 49.037V45.1682ZM14.991 33.21C14.991 36.8573 14.991 38.6809 16.1309 39.8151C17.2708 40.9494 19.106 40.9477 22.7748 40.9477C26.4435 40.9477 28.2787 40.9477 29.4186 39.8151C30.5585 38.6791 30.5585 36.8573 30.5585 33.21V29.3412C30.5585 25.6939 30.5585 23.8703 29.4186 22.736C28.2787 21.6018 26.4435 21.6035 22.7748 21.6035C19.106 21.6035 17.2708 21.6035 16.1309 22.736C14.991 23.8721 14.991 25.6939 14.991 29.3412V33.21ZM34.018 27.7585C34.018 25.8469 34.018 24.892 34.3138 24.1358C34.7002 23.1422 35.4576 22.3444 36.4206 21.9165C37.135 21.6035 38.0431 21.6035 39.8558 21.6035H43.7477C45.5605 21.6035 46.4686 21.6035 47.183 21.9165C48.136 22.3316 48.8954 23.1299 49.2898 24.1358C49.5856 24.892 49.5856 25.8469 49.5856 27.7585C49.5856 29.67 49.5856 30.6249 49.2898 31.3811C48.9034 32.3747 48.146 33.1726 47.183 33.6004C46.4686 33.9134 45.5605 33.9134 43.7477 33.9134H39.8558C38.0431 33.9134 37.135 33.9134 36.4206 33.6004C35.4576 33.1726 34.7002 32.3747 34.3138 31.3811C34.018 30.6249 34.018 29.67 34.018 27.7585ZM14.991 50.6197C14.991 52.5313 14.991 53.4862 15.2868 54.2424C15.6731 55.236 16.4305 56.0338 17.3936 56.4617C18.1079 56.7747 19.016 56.7747 20.8288 56.7747H24.7207C26.5335 56.7747 27.4416 56.7747 28.1559 56.4617C29.109 56.0466 29.8684 55.2483 30.2628 54.2424C30.5585 53.4862 30.5585 52.5313 30.5585 50.6197C30.5585 48.7082 30.5585 47.7533 30.2628 46.9971C29.8764 46.0035 29.119 45.2056 28.1559 44.7778C27.4416 44.4648 26.5335 44.4648 24.7207 44.4648H20.8288C19.016 44.4648 18.1079 44.4648 17.3936 44.7778C16.4405 45.1928 15.6811 45.9912 15.2868 46.9971C14.991 47.7533 14.991 48.7082 14.991 50.6197Z" fill="${contrastText}"/>`;
  if (currentSpace.type === "static") {
    switch (currentSpace.id) {
      case "todo":
        innerIcon = `<path d="M44.7395 25.7238C45.1171 25.5028 45.5681 25.4327 45.9977 25.5283C46.4273 25.6238 46.8022 25.8775 47.0437 26.2362L48.7309 28.7401C48.9508 29.0672 49.0449 29.4594 48.9966 29.8474C48.9483 30.2355 48.7606 30.5944 48.4667 30.861L48.4616 30.8676L48.3406 30.977L47.9571 31.3335C45.8354 33.3361 43.778 35.4021 41.7877 37.5286C38.0434 41.5348 33.597 46.778 30.6043 51.8654C29.7692 53.2848 27.7292 53.5899 26.5192 52.3645L15.4671 41.1916C15.3087 41.0314 15.185 40.8418 15.1034 40.6342C15.0218 40.4266 14.9839 40.2052 14.992 39.983C15.0001 39.7609 15.0541 39.5426 15.1506 39.3412C15.2471 39.1397 15.3843 38.9592 15.554 38.8104L18.8943 35.8787C19.1879 35.6212 19.5643 35.4709 19.9591 35.4537C20.354 35.4365 20.7427 35.5533 21.0588 35.7842L26.6982 39.8982C35.5075 31.4463 40.5027 28.2029 44.7395 25.7238Z" fill="${contrastText}"/>`;
        break;
      case "bookmark":
        innerIcon = `<path d="M39.5918 21.7789C34.7576 20.9806 29.8225 20.9806 24.9883 21.7789C24.1254 21.9198 23.3263 22.316 22.697 22.915C22.0677 23.5139 21.6379 24.2874 21.4647 25.1327C19.845 33.0605 19.7562 41.2184 21.203 49.1787L21.7935 52.4209C21.8353 52.6472 21.9383 52.8581 22.0917 53.0314C22.245 53.2047 22.4431 53.3339 22.6648 53.4053C22.8865 53.4768 23.1237 53.4878 23.3513 53.4373C23.5789 53.3867 23.7883 53.2764 23.9576 53.1181L31.0701 46.456C31.3988 46.148 31.8349 45.9762 32.2883 45.9762C32.7417 45.9762 33.1778 46.148 33.5064 46.456L40.619 53.1181C40.7882 53.2764 40.9977 53.3867 41.2253 53.4373C41.4528 53.4878 41.69 53.4768 41.9118 53.4053C42.1335 53.3339 42.3315 53.2047 42.4849 53.0314C42.6383 52.8581 42.7413 52.6472 42.783 52.4209L43.3735 49.1787C44.8203 41.2184 44.7316 33.0605 43.1119 25.1327C42.9392 24.2875 42.5101 23.5141 41.8815 22.9148C41.2528 22.3156 40.4543 21.9188 39.5918 21.7772" fill="${contrastText}"/>`;
        break;
      case "note":
        innerIcon = `<path d="M26.5347 23.0788V20.5263C26.5347 19.8286 25.9561 19.25 25.2584 19.25C24.5607 19.25 23.9821 19.8286 23.9821 20.5263V23.1809C24.4076 23.1298 24.7989 23.0788 25.2584 23.0788H26.5347Z" fill="${contrastText}"/><path d="M40.1482 23.1809V20.5263C40.1482 19.8286 39.5696 19.25 38.8719 19.25C38.1742 19.25 37.5957 19.8286 37.5957 20.5263V23.0788H38.8719C39.3314 23.0788 39.7228 23.1298 40.1482 23.1809Z" fill="${contrastText}"/><path d="M40.1482 23.1809L40.1481 25.6313C40.1481 26.329 39.5696 26.9076 38.8719 26.9076C38.1742 26.9076 37.5956 26.329 37.5956 25.6313L37.5957 23.0788H26.5347L26.5347 25.6313C26.5347 26.329 25.9561 26.9076 25.2584 26.9076C24.5607 26.9076 23.9821 26.329 23.9821 25.6313L23.9821 23.1809C18.9622 23.6403 16.75 26.8735 16.75 31.5872V46.0515C16.75 51.1565 19.3025 54.5599 25.2584 54.5599H38.8719C44.8277 54.5599 47.3803 51.1565 47.3803 46.0515V31.5872C47.3803 26.8735 45.1681 23.6403 40.1482 23.1809ZM32.0651 45.6261H25.2584C24.5607 45.6261 23.9821 45.0475 23.9821 44.3498C23.9821 43.6521 24.5607 43.0735 25.2584 43.0735H32.0651C32.7628 43.0735 33.3414 43.6521 33.3414 44.3498C33.3414 45.0475 32.7628 45.6261 32.0651 45.6261ZM38.8719 37.1177H25.2584C24.5607 37.1177 23.9821 36.5391 23.9821 35.8414C23.9821 35.1437 24.5607 34.5651 25.2584 34.5651H38.8719C39.5696 34.5651 40.1481 35.1437 40.1481 35.8414C40.1481 36.5391 39.5696 37.1177 38.8719 37.1177Z" fill="${contrastText}"/>`;
        break;
      case "habit-tracker":
        innerIcon = `<path d="M25.4109 21.8502C25.4109 21.5196 25.28 21.2025 25.047 20.9687C24.8141 20.7349 24.4981 20.6035 24.1686 20.6035C23.8392 20.6035 23.5232 20.7349 23.2902 20.9687C23.0573 21.2025 22.9264 21.5196 22.9264 21.8502V24.4767C20.5413 24.6678 18.9777 25.1366 17.8282 26.2919C16.677 27.4455 16.21 29.0164 16.0178 31.4084H48.8827C48.6906 29.0147 48.2235 27.4455 47.0723 26.2919C45.9228 25.1366 44.3576 24.6678 41.9742 24.475V21.8502C41.9742 21.5196 41.8433 21.2025 41.6103 20.9687C41.3773 20.7349 41.0614 20.6035 40.7319 20.6035C40.4024 20.6035 40.0865 20.7349 39.8535 20.9687C39.6205 21.2025 39.4897 21.5196 39.4897 21.8502V24.3653C38.3882 24.3437 37.1526 24.3437 35.7629 24.3437H29.1376C27.7479 24.3437 26.5123 24.3437 25.4109 24.3653V21.8502Z" fill="${contrastText}"/><path fill-rule="evenodd" clip-rule="evenodd" d="M15.5676 37.2978C15.5676 35.9411 15.5676 34.7348 15.5893 33.6594H48.861C48.8827 34.7348 48.8827 35.9411 48.8827 37.2978V40.5319C48.8827 46.6298 48.8827 49.6796 46.9304 51.5732C44.9782 53.4668 41.8382 53.4684 35.5567 53.4684H28.8937C22.6121 53.4684 19.4705 53.4684 17.5199 51.5732C15.5693 49.678 15.5676 46.6298 15.5676 40.5319V37.2978ZM40.5539 40.5319C40.9957 40.5319 41.4194 40.3615 41.7318 40.0583C42.0442 39.755 42.2197 39.3437 42.2197 38.9149C42.2197 38.486 42.0442 38.0747 41.7318 37.7714C41.4194 37.4682 40.9957 37.2978 40.5539 37.2978C40.1121 37.2978 39.6885 37.4682 39.3761 37.7714C39.0637 38.0747 38.8882 38.486 38.8882 38.9149C38.8882 39.3437 39.0637 39.755 39.3761 40.0583C39.6885 40.3615 40.1121 40.5319 40.5539 40.5319ZM40.5539 47.0001C40.9957 47.0001 41.4194 46.8298 41.7318 46.5265C42.0442 46.2233 42.2197 45.812 42.2197 45.3831C42.2197 44.9542 42.0442 44.5429 41.7318 44.2397C41.4194 43.9364 40.9957 43.766 40.5539 43.766C40.1121 43.766 39.6885 43.9364 39.3761 44.2397C39.0637 44.5429 38.8882 44.9542 38.8882 45.3831C38.8882 45.812 39.0637 46.2233 39.3761 46.5265C39.6885 46.8298 40.1121 47.0001 40.5539 47.0001ZM33.8909 38.9149C33.8909 39.3437 33.7154 39.755 33.403 40.0583C33.0906 40.3615 32.6669 40.5319 32.2252 40.5319C31.7834 40.5319 31.3597 40.3615 31.0473 40.0583C30.7349 39.755 30.5594 39.3437 30.5594 38.9149C30.5594 38.486 30.7349 38.0747 31.0473 37.7714C31.3597 37.4682 31.7834 37.2978 32.2252 37.2978C32.6669 37.2978 33.0906 37.4682 33.403 37.7714C33.7154 38.0747 33.8909 38.486 33.8909 38.9149ZM33.8909 45.3831C33.8909 45.812 33.7154 46.2233 33.403 46.5265C33.0906 46.8298 32.6669 47.0001 32.2252 47.0001C31.7834 47.0001 31.3597 46.8298 31.0473 46.5265C30.7349 46.2233 30.5594 45.812 30.5594 45.3831C30.5594 44.9542 30.7349 44.5429 31.0473 44.2397C31.3597 43.9364 31.7834 43.766 32.2252 43.766C32.6669 43.766 33.0906 43.9364 33.403 44.2397C33.7154 44.5429 33.8909 44.9542 33.8909 45.3831ZM23.8964 40.5319C24.3382 40.5319 24.7619 40.3615 25.0743 40.0583C25.3867 39.755 25.5621 39.3437 25.5621 38.9149C25.5621 38.486 25.3867 38.0747 25.0743 37.7714C24.7619 37.4682 24.3382 37.2978 23.8964 37.2978C23.4546 37.2978 23.0309 37.4682 22.7185 37.7714C22.4061 38.0747 22.2306 38.486 22.2306 38.9149C22.2306 39.3437 22.4061 39.755 22.7185 40.0583C23.0309 40.3615 23.4546 40.5319 23.8964 40.5319ZM23.8964 47.0001C24.3382 47.0001 24.7619 46.8298 25.0743 46.5265C25.3867 46.2233 25.5621 45.812 25.5621 45.3831C25.5621 44.9542 25.3867 44.5429 25.0743 44.2397C24.7619 43.9364 24.3382 43.766 23.8964 43.766C23.4546 43.766 23.0309 43.9364 22.7185 44.2397C22.4061 44.5429 22.2306 44.9542 22.2306 45.3831C22.2306 45.812 22.4061 46.2233 22.7185 46.5265C23.0309 46.8298 23.4546 47.0001 23.8964 47.0001Z" fill="${contrastText}"/>`;
    }
  }
  const svg = `<svg width="64" height="64" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M15.9906 8.8384L12.7313 11.3376C7.7903 15.1264 5.31653 17.0208 3.99327 19.6896C2.66675 22.3616 2.66675 25.4464 2.66675 31.616V38.3104C2.66675 50.4192 2.66675 56.4736 6.4866 60.2368C10.3065 64 16.4502 64 28.7408 64H35.2593C47.55 64 53.697 64 57.5136 60.2368C61.3302 56.4736 61.3334 50.4192 61.3334 38.3072V31.6192C61.3334 25.4464 61.3334 22.3616 60.0069 19.6896C58.6804 17.0208 56.2099 15.1264 51.2688 11.3376L48.0096 8.8416C40.3177 2.944 36.4718 0 32.0001 0C27.5284 0 23.6825 2.944 15.9906 8.8384Z" fill="${main}"/> ${innerIcon} </svg>`;
  useEffect(() => {
    const favicon = document.getElementById("favicon") as HTMLLinkElement;
    if (favicon)
      favicon.href = `data:image/svg+xml;charset=utf-8,${encodeURIComponent(
        svg
      )}`;
  }, [svg]);
}
